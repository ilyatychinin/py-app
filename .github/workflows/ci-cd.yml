name: Simple CI with Docker Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Syntax check
        run: |
          python -m py_compile $(find . -name "*.py" -not -path "./.git/*")

      - name: Build ALL images locally (app, nginx, bot)
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º app –∏–∑ Dockerfile.dev
          docker build -f Dockerfile.dev -t py-app-test .
          
          # –°–æ–±–∏—Ä–∞–µ–º nginx
          docker build -f Dockerfile.nginx -t py-nginx-test .
          
          # –°–æ–±–∏—Ä–∞–µ–º bot
          docker build -f Dockerfile.bot -t py-bot-test .

      # ‚Üê –ö–õ–Æ–ß–ï–í–û–ô –ú–û–ú–ï–ù–¢: –∑–∞–ø—É—Å–∫–∞–µ–º docker-compose!
      - name: Start full stack with docker compose v2
        run: |
          # –°–æ–∑–¥–∞—ë–º docker-compose.ci.yml (—Ç–æ—Ç –∂–µ)
          cat > docker-compose.ci.yml << EOF
          services:
            postgres:
              image: postgres:18
              environment:
                POSTGRES_USER: admin
                POSTGRES_PASSWORD: admin  
                POSTGRES_DB: myapp
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U admin -d myapp"]
                interval: 5s
                timeout: 5s
                retries: 10
            
            app:
              image: py-app-test
              ports:
                - "5000:5000"
              depends_on:
                postgres:
                  condition: service_healthy
              environment:
                DATABASE_URL: postgresql://admin:admin@postgres:5432/myapp
            
            nginx:
              image: py-nginx-test
              ports:
                - "8080:80"
              depends_on:
                - app
          EOF

          # Docker Compose V2 (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, –µ—Å—Ç—å –≤ GitHub Actions)
          docker compose -f docker-compose.ci.yml up -d postgres app nginx

      - name: Wait for services
        run: |
          echo "Waiting for Postgres..."
          docker compose -f docker-compose.ci.yml exec postgres pg_isready -U admin -d myapp
          
          echo "Waiting for Nginx..."
          timeout 60 bash -c 'until curl -fs http://localhost:8080/health; do echo "Waiting..."; sleep 3; done' || exit 1


      - name: Wait for services
        run: |
          echo "Waiting for Postgres..."
          docker compose -f docker-compose.ci.yml exec -T postgres pg_isready -U admin -d myapp
          
          echo "Waiting for Nginx..."
          for i in {1..30}; do
            if curl -fs http://localhost:8080/health >/dev/null 2>&1; then
              echo "‚úÖ Full stack is up!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 3
          done || (echo "Services not ready" && exit 1)

      - name: Test full API through Nginx
        run: |
          echo "üß™ Testing through Nginx (port 8080):"
          
          # 1. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ—Ç)
          curl -fs -X POST http://localhost:8080/users \
            -H "Content-Type: application/json" \
            -d '{"name":"CI User", "email":"ci@test.com"}'

          # Health —á–µ—Ä–µ–∑ nginx
          curl -fs http://localhost:8080/health
          
          # Stats —á–µ—Ä–µ–∑ nginx  
          curl -fs http://localhost:8080/stats
          
          # –°–æ–∑–¥–∞—Ç—å TODO —á–µ—Ä–µ–∑ nginx
          curl -fs -X POST http://localhost:8080/todos \
            -H "Content-Type: application/json" \
            -d '{"user_id":1, "task":"CI test task", "completed":false}'
          
          # –ü–æ–ª—É—á–∏—Ç—å todos
          curl -fs http://localhost:8080/todos

      - name: Show logs if failed
        if: failure()
        run: |
          echo "===== Logs ====="
          docker compose -f docker-compose.ci.yml logs app
          docker compose -f docker-compose.ci.yml logs nginx
          docker compose -f docker-compose.ci.yml logs postgres

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.ci.yml down -v
          docker image rm py-app-test py-nginx-test py-bot-test || true
  deploy:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}  # bore.pub
          port: ${{ secrets.SERVER_SSH_PORT }}  # 12345
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ilyatychinin/devops_train_projects/my-python-app
            docker compose down
            git pull origin main
            docker compose up -d
            curl localhost:8080/health
    

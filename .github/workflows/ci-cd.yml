name: Simple CI with Docker Compose

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Syntax check
        run: |
          python -m py_compile $(find . -name "*.py" -not -path "./.git/*")

      - name: Build ALL images locally (app, nginx, bot)
        run: |
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ app Ð¸Ð· Dockerfile.dev
          docker build -f Dockerfile.dev -t py-app-test .
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ nginx
          docker build -f Dockerfile.nginx -t py-nginx-test .
          
          # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ bot
          docker build -f Dockerfile.bot -t py-bot-test .

      # â† ÐšÐ›Ð®Ð§Ð•Ð’ÐžÐ™ ÐœÐžÐœÐ•ÐÐ¢: Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ docker-compose!
      - name: Start full stack with docker-compose
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ docker-compose.yml Ð´Ð»Ñ CI
          cat > docker-compose.ci.yml << EOF
          services:
            postgres:
              image: postgres:18
              environment:
                POSTGRES_USER: admin
                POSTGRES_PASSWORD: admin  
                POSTGRES_DB: myapp
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U admin -d myapp"]
                interval: 5s
                timeout: 5s
                retries: 10
            
            app:
              image: py-app-test  # â† Ð½Ð°Ñˆ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð·!
              ports:
                - "5000:5000"
              depends_on:
                postgres:
                  condition: service_healthy
              environment:
                DATABASE_URL: postgresql://admin:admin@postgres:5432/myapp
            
            nginx:
              image: py-nginx-test
              ports:
                - "8080:80"
              depends_on:
                - app
            
            bot:
              image: py-bot-test
              depends_on:
                - app
          EOF

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼!
          docker compose up -d -f docker-compose.ci.yml 

      - name: Wait for services
        run: |
          echo "Waiting for Postgres..."
          docker-compose -f docker-compose.ci.yml exec -T postgres pg_isready -U admin -d myapp
          
          echo "Waiting for Nginx..."
          for i in {1..30}; do
            if curl -fs http://localhost:8080/health >/dev/null 2>&1; then
              echo "âœ… Full stack is up!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 3
          done || (echo "Services not ready" && exit 1)

      - name: Test full API through Nginx
        run: |
          echo "ðŸ§ª Testing through Nginx (port 8080):"
          
          # Health Ñ‡ÐµÑ€ÐµÐ· nginx
          curl -fs http://localhost:8080/health
          
          # Stats Ñ‡ÐµÑ€ÐµÐ· nginx  
          curl -fs http://localhost:8080/stats
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ TODO Ñ‡ÐµÑ€ÐµÐ· nginx
          curl -fs -X POST http://localhost:8080/todos \
            -H "Content-Type: application/json" \
            -d '{"user_id":1, "task":"CI test task", "completed":false}'
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ todos
          curl -fs http://localhost:8080/todos

      - name: Show logs if failed
        if: failure()
        run: |
          echo "===== Logs ====="
          docker-compose -f docker-compose.ci.yml logs app
          docker-compose -f docker-compose.ci.yml logs nginx
          docker-compose -f docker-compose.ci.yml logs postgres

      - name: Cleanup
        if: always()
        run: |
          docker-compose -f docker-compose.ci.yml down -v
          docker image rm py-app-test py-nginx-test py-bot-test || true

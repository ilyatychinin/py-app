      - name: Start full stack with docker compose v2
        run: |
          # Создаём docker-compose.ci.yml (тот же)
          cat > docker-compose.ci.yml << EOF
          services:
            postgres:
              image: postgres:18
              environment:
                POSTGRES_USER: admin
                POSTGRES_PASSWORD: admin  
                POSTGRES_DB: myapp
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U admin -d myapp"]
                interval: 5s
                timeout: 5s
                retries: 10
            
            app:
              image: py-app-test
              ports:
                - "5000:5000"
              depends_on:
                postgres:
                  condition: service_healthy
              environment:
                DATABASE_URL: postgresql://admin:admin@postgres:5432/myapp
            
            nginx:
              image: py-nginx-test
              ports:
                - "8080:80"
              depends_on:
                - app
          EOF

          # Docker Compose V2 (современный, есть в GitHub Actions)
          docker compose -f docker-compose.ci.yml up -d postgres app nginx

      - name: Wait for services
        run: |
          echo "Waiting for Postgres..."
          docker compose -f docker-compose.ci.yml exec postgres pg_isready -U admin -d myapp
          
          echo "Waiting for Nginx..."
          timeout 60 bash -c 'until curl -fs http://localhost:8080/health; do echo "Waiting..."; sleep 3; done' || exit 1
